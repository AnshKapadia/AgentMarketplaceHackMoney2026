CREATE TABLE agents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) UNIQUE NOT NULL,
    wallet_address VARCHAR(64),
    api_key_hash VARCHAR(256) NOT NULL,
    
    -- Capabilities (searchable)
    capabilities JSONB NOT NULL DEFAULT '[]',
    -- e.g., ["copywriting", "react", "python", "design"]
    
    -- Pricing
    hourly_rate_usd DECIMAL(10,2),
    task_types JSONB DEFAULT '[]',
    -- e.g., [{"type": "landing_page_copy", "price": 50}]
    
    -- Reputation (cached from chain)
    reputation_score DECIMAL(5,2) DEFAULT 0,
    jobs_completed INTEGER DEFAULT 0,
    
    -- Metadata
    description TEXT,
    status VARCHAR(20) DEFAULT 'available',
    -- available, busy, offline
    
    created_at TIMESTAMP DEFAULT NOW(),
    last_seen_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    client_agent_id UUID REFERENCES agents(id),
    
    title VARCHAR(200) NOT NULL,
    description TEXT NOT NULL,
    required_capabilities JSONB NOT NULL DEFAULT '[]',
    budget_usd DECIMAL(10,2),
    deadline TIMESTAMP,
    
    status VARCHAR(20) DEFAULT 'open',
    -- open, in_progress, completed, cancelled
    
    -- For sub-jobs in collaboration chains
    parent_job_id UUID REFERENCES jobs(id),
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE bids (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_id UUID REFERENCES jobs(id),
    agent_id UUID REFERENCES agents(id),
    
    proposed_price DECIMAL(10,2),
    message TEXT,
    estimated_hours DECIMAL(5,2),
    
    status VARCHAR(20) DEFAULT 'pending',
    -- pending, accepted, rejected
    
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(job_id, agent_id)
);

CREATE TABLE contracts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_id UUID REFERENCES jobs(id) UNIQUE,
    client_agent_id UUID REFERENCES agents(id),
    worker_agent_id UUID REFERENCES agents(id),
    
    agreed_price DECIMAL(10,2),
    
    status VARCHAR(20) DEFAULT 'active',
    -- active, completed, disputed
    
    -- Blockchain reference
    chain_tx_hash VARCHAR(128),
    escrow_address VARCHAR(64),
    
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);

CREATE TABLE deliverables (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    contract_id UUID REFERENCES contracts(id),
    
    artifact_type VARCHAR(50),
    -- code, text, image_url, file_url, json
    content TEXT,
    metadata JSONB DEFAULT '{}',
    
    submitted_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    from_agent_id UUID REFERENCES agents(id),
    to_agent_id UUID REFERENCES agents(id),
    
    job_id UUID REFERENCES jobs(id),
    message_type VARCHAR(20),
    -- job_offer, bid_received, work_request, delivery, feedback
    content JSONB NOT NULL,
    
    read_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE activity_log (
    id BIGSERIAL PRIMARY KEY,
    event_type VARCHAR(50) NOT NULL,
    agent_id UUID REFERENCES agents(id),
    job_id UUID REFERENCES jobs(id),
    data JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_agents_capabilities ON agents USING GIN(capabilities);
CREATE INDEX idx_jobs_status ON jobs(status);
CREATE INDEX idx_jobs_required_caps ON jobs USING GIN(required_capabilities);
CREATE INDEX idx_messages_to_agent ON messages(to_agent_id, read_at);
CREATE INDEX idx_activity_created ON activity_log(created_at DESC);
